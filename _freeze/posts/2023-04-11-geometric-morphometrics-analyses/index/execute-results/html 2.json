{
  "hash": "00761a1b89fdd7b277d4820042ef5b09",
  "result": {
    "markdown": "---\ntitle: \"Procrustes Superimposition and Analyses\"\nauthor:\n  - name: Marguerite Butler\n    url: https://butlerlab.org\n    affiliation: School of Life Sciences, University of Hawaii\n    affiliation_url: https://manoa.hawaii.edu/lifesciences/\ndescription: \"A tour of analyses with geometric morphometric data\"\ndate: 2023-04-11\ncategories: [module 6, week 13, geometric morphometrics, GPA, procrustes superimposition, size, shape]\nbibliography: ../refs.bib\n---\n\n\n### Acknowledgements\n\nReferences for this Material:\n\n- The authors of the `geomorph` package for developing many useful vignettes (Antigoni Kaliontzopoulou) and sample datasets which is drawn upon below \n- Bardua et al (2019) A Practical Guide to Sliding and Surface Semilandmarks in Morphometric Analyses<https://academic.oup.com/iob/article/1/1/obz016/5526881>\n- [Emma Sherratʻs quick guide to Geomorph](https://www.researchgate.net/profile/Alexandre-Palaoro/post/Geomorph-Package-in-R/attachment/5cffb777cfe4a7968da98557/AS%3A768610867900420%401560262519604/download/Quick_Guide_to_Geomorph-3.0.pdf)\n\n# Learning objectives\n\n::: callout-note\n# Learning objectives\n\n**At the end of this lesson you will:**\n\n-   Be able to create shape data from geometric morphometric data\n-   Understand the general concepts for Procrustes superimposition \n-   Be able to perform basic analyses on geometric morphometric data\n\n:::\n\n\n# The goals of Geometric Morphometrics \n\nFrom [@MacLeod:2010]:\n\n> __The ultimate goals for any geometric morphometric analysis__ - to define a mathematical space in which we can compare sets of landmark configurations that (1) ordinates shapes on the basis of their similarity, (2) treats these configurations as a __whole entity__ rather than an accumulation of _independent parts_, (3) respects the conventions of the Kendall shape space, (4) supports shape modelling, and (5) is stable in the face of minor changes to the sample and/or reference shape.\n\nWhat is a Kendall shape space, you ask? A shape space or coordinate system is used to describes shapes, and importantly, be used to understand differences between shapes. Kendallʻs shape space describes curves and local approxmation to curves using tangents [@Klingenberg:2020]. For this lesson just remember that shapes are connected by geometries, which we can describe mathematically. This makes it much easier to compare the major differences between multidimensional shapes. \n\n\n# Size Adjustment with Procrustes Superimposition \n\nProcrustes superimposition is the most widely used method to create size and shape variables from landmark data. The basic idea is that larger objects should have landmarks that are farther apart than the same landmarks in smaller objects. \n\n### Centroid\n\nA key concept is the __centroid__, which the center point of all of the landmarks. It is easily calculated for each specimen by taking the average of all of the landmark coordinates along each axis. For _p_ landmarks in two dimensions the coordinates of the centroid would be:\n\n$$\nC_{x} = \\frac{X_1+X_2+X_3+ ... + X_p}{p}\n$$\n$$\nC_{y} = \\frac{Y_1+Y_2+Y_3 ... + Y_p}{p}\n$$\n\n### Centroid size\n\nThe concept of __centroid size__ describes geometric size. It is calculated from the distances of each landmark from the centroid, but it is a geometric mean because it is caculated by taking the square-root of the sums of squared distances of each landmark from the centroid.  \n\n![The centroid of a triangle (with landmarks at the vertices) is the point in the center.](../../images/Triangle.Centroid.png)\n\n[Source: Wikipedia]\n\n### Shape Variables \n\nShape variables calculated from Procrustes superimposition mathematically separate scale (size) from shape by applying shape-preserving transformations to make the landmarks as similar as possible. \n\nThe concept: In order to compare differences in shape, we can remove size  (in other words, normalize by size or bring all of the specimens to the same size) with the following transformations:\n\n-  __Scale__: Bring each set of landmarks to the same size by magnifing or reducing the distances of the landmarks around their centroid.  \n-   __Translate__: Shift the landmarks in the coordinate space to place the centroids at a common point.  \n-  __Rotate__: Rotate the landmarks with an angular transformation to bring them into a common orientation. \n \n\nAt the end of Procrustes superimposition, the landmarks for the different specimens will be scaled to the same size and their coordinates will lie as close together as possible while preserving the differences in shape. The figure below illustrates these steps. \n\nThe mathematics of these transofrmations come from basic linear algebra operations on matrices, which are beyond the scope of the class, but to understand what is happening we can analogize it to univariate arithmetic.  \n\n_Scaling_ is like dividing each variable by a size variable to put all of the individuals on the same baseline with regard to size (magnitude). \n\n_Translation_ brings the centers of all of the landmarks into alignment. Think of a situation where we measured the length of specimens according to wherever they fell within the picture frame, for example if one specimen started at 2 and extended to 10, and another started at 6 and extended to 12. We could translate (or slide) each of these to place their midpoint at zero by subtracting the mean value from each of their endpoints. For the first specimen, we would subtract 6, translating the specimen from (2,10) to (-4,4), and for the second we would subtract 9, tanslating the specimen from (6,12) to (-3,3).  \n\n_Rotation_ is an angular rotation to bring a 2 or 3D object into a common orientation. For a more thorough discussion please see [@Zelditch:2004].\n\n![Figure: Procrustes superimposition. The figure shows the three transformation steps of an ordinary Procrustes fit for two configurations of landmarks. (a) Scaling of both configurations to the same size; (b) Translation to the same position of the center of gravity; (c) Rotation to the orientation that provides the minimum sum of squared distances between corresponding landmarks.](../../images/Procrustes_superimposition.png)\n\n[Source: Christian Klingenberg](https://commons.wikimedia.org/wiki/File:Procrustes_superimposition.png)\n\n::: callout-note\n## From the documentation for `gpagen()` in `geomorph`:\nGPA translates all specimens to the origin, scales them to unit-centroid size, and optimally rotates them (using a least-squares criterion) until the coordinates of corresponding points align as closely as possible. The resulting aligned Procrustes coordinates represent the shape of each specimen, and are found in a curved space related to Kendall's shape space (Kendall 1984). Typically, these are projected into a linear tangent space yielding Kendall's tangent space coordinates (i.e., Procrustes shape variables), which are used for subsequent multivariate analyses (Dryden and Mardia 1993, Rohlf 1999). \n:::\n\n# Geomorph Package\n\n### Data Structures\n\nThe package `geomorph` is written to work with standard geomorphic morphometrics data file types such as TPS and NTS, as well as others [@Adams:2022,@Baken:2021]. \n\n`readland.tps()` reads morphometric data in TPS format. It returns an array for storing landmark data: _p_ landmarks X _k_ dimensions X _N_ specimens\n\nThe third dimension of this array contains names for each specimen, which are obtained from the image names in the _.tps_ file.\n\n\n### Built-in Example\n\nLetʻs look again at the built-in dataset `plethodon` that comes with `geomorph`. It has skull landmark data for 40 specimens of two species of plethdon salamanders [@Adams:2004]. \n\n![_Plethodon jordani_, Photo by Kevin Stohlgren](../../images/plethodonjordani.png)\n\n[Source: Ambibians and Reptiles of North Carolina website](https://herpsofnc.org/jordans-salamander/)\n\n\nThe dataset `plethodon` is a list.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(geomorph)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: geomorph\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: RRPP\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: rgl\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: Matrix\n```\n:::\n\n```{.r .cell-code}\ndata(plethodon) \nclass(plethodon)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"list\"\n```\n:::\n\n```{.r .cell-code}\nattributes(plethodon)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$names\n[1] \"land\"    \"links\"   \"species\" \"site\"    \"outline\"\n```\n:::\n\n```{.r .cell-code}\ntable(plethodon$species)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n Jord Teyah \n   20    20 \n```\n:::\n\n```{.r .cell-code}\ndim(plethodon$land)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 12  2 40\n```\n:::\n:::\n\n\nThe landmarks are in `plethodon$land`. There are twenty of each species, and from the dimensions  of `plethodon$land` we see that each of the 40 specimens has 12 landmarks in two dimensions. \n\n`plotAllSpecimens` plots the coordinates of all samples, so we can start to look at variation. \n\n#### Shape: General Procrustes Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#|warning: false\nplotAllSpecimens(plethodon$land)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n\n```{.r .cell-code}\nY.gpa <- gpagen(plethodon$land, PrinAxes = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nPerforming GPA\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |==================                                                    |  25%\n  |                                                                            \n  |===================================                                   |  50%\n  |                                                                            \n  |======================================================================| 100%\n\nMaking projections... Finished!\n```\n:::\n\n```{.r .cell-code}\nsummary(Y.gpa)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\ngpagen(A = plethodon$land, PrinAxes = FALSE) \n\n\n\nGeneralized Procrustes Analysis\nwith Partial Procrustes Superimposition\n\n12 fixed landmarks\n0 semilandmarks (sliders)\n2-dimensional landmarks\n2 GPA iterations to converge\n\n\nConsensus (mean) Configuration\n\n             X            Y\n1   0.15263287 -0.023350400\n2   0.19445064 -0.092643121\n3  -0.03361223 -0.007346212\n4  -0.28069721 -0.092850147\n5  -0.30998751 -0.061672264\n6  -0.32557841 -0.036112255\n7  -0.31804390  0.036125318\n8  -0.18947114  0.098010902\n9   0.02036829  0.099112877\n10  0.18852641  0.077278061\n11  0.35134314  0.065866346\n12  0.55006905 -0.062419105\n```\n:::\n:::\n\n\nThe summary provides the mean for each of the coordinates after GPA. We can see the mean of the coordinates among the individual coordinates by plotting:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(Y.gpa)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nLetʻs compare the plot of all specimens before and after Generalized Procrustes Analysis. The below plot is before GPA, on the raw landmarks `plethodon$land`:\n\n::: {.cell}\n\n```{.r .cell-code}\nplotAllSpecimens(plethodon$land)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nPlotting again after alignment with Generalized Procrustes Analysis gives a good representation of shape variation. Plotting links between the landmarks helps with visualization. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotAllSpecimens(Y.gpa$coords,links=plethodon$links)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n#### Principal Components Analysis\n\nPCA on the procrustes coordinates (size-adjusted or shape variables) can be done with: \n\n::: {.cell}\n\n```{.r .cell-code}\npleth.pca <- gm.prcomp(Y.gpa$coords)\npleth.pca \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nOrdination type: Principal Component Analysis \nCentering by OLS mean\nOrthogonal projection of OLS residuals\nNumber of observations: 40 \nNumber of vectors 20 \n\nImportance of Components:\n                             Comp1       Comp2        Comp3        Comp4\nEigenvalues            0.001855441 0.001566597 0.0004141056 0.0002278444\nProportion of Variance 0.367433295 0.310233333 0.0820053761 0.0451200584\nCumulative Proportion  0.367433295 0.677666628 0.7596720044 0.8047920628\n                              Comp5        Comp6        Comp7        Comp8\nEigenvalues            0.0001725997 0.0001672575 0.0001549008 0.0001251132\nProportion of Variance 0.0341799312 0.0331220169 0.0306750315 0.0247761773\nCumulative Proportion  0.8389719940 0.8720940109 0.9027690424 0.9275452197\n                              Comp9       Comp10       Comp11       Comp12\nEigenvalues            8.468503e-05 6.869926e-05 5.430853e-05 4.423148e-05\nProportion of Variance 1.677019e-02 1.360452e-02 1.075473e-02 8.759165e-03\nCumulative Proportion  9.443154e-01 9.579199e-01 9.686747e-01 9.774338e-01\n                             Comp13       Comp14       Comp15       Comp16\nEigenvalues            0.0000261742 0.0000192644 1.741769e-05 1.715141e-05\nProportion of Variance 0.0051832795 0.0038149309 3.449226e-03 3.396495e-03\nCumulative Proportion  0.9826170994 0.9864320303 9.898813e-01 9.932778e-01\n                             Comp17       Comp18       Comp19       Comp20\nEigenvalues            1.555244e-05 9.253679e-06 5.336746e-06 3.802714e-06\nProportion of Variance 3.079853e-03 1.832507e-03 1.056837e-03 7.530520e-04\nCumulative Proportion  9.963576e-01 9.981901e-01 9.992469e-01 1.000000e+00\n```\n:::\n:::\n\nThere are 20 PC axes, with 67% of the total shape variation in the first two axes. A plot on PC1 vs PC2 reveals several distinct clusters, suggesting shape differences. The scores are in `pleth.pca$x`. There is a plot method for geomorph pca results:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npleth.pca.plot <- plot(pleth.pca)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\nThe specimens are from two species in two distinct environments, and there seems to be  some separation between the points along PC1 vs. PC2. These points correspond to specimens of two different species in the original TPS data that information is in `plethodon$species`. Because the species names are a factor, we can use this to do a quick and dirty plot colored by species. We can plot additional PC axes by specifying the axes to plot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(plethodon$species)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"factor\"\n```\n:::\n\n```{.r .cell-code}\npar(mfrow=c(2,2)) # set up 2x2 plots\nplot(pleth.pca, main = \"PCA\", \n      col=plethodon$species # color points by species\n    )\nplot(pleth.pca, main = \"PCA\", \n      axis1 = 1, axis2 = 3, # plot PC axes 1 vs 3\n      col=plethodon$species \n    )\nplot(pleth.pca, main = \"PCA\", \n      axis1 = 2, axis2 = 3, # PC 2 vs PC3\n      col=plethodon$species\n    ) \nplot(pleth.pca, main = \"PCA\", \n      axis1 = 3, axis2 = 4, # PC3 vs PC4\n      col=plethodon$species\n    ) \n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nAll of the separation between species comes from PC1 vs. 2, with no additional separation by adding PC3 or PC4. \n\n#### Statistical test for differences among species and sites\n\nWe can test the shape variables (GPA coordinates) as explanatory variables for phenotypic varation. Because there are multiple pheontypic (Y) variables, we use MANOVA (multivariate ANOVA). \n\n`geomorph` has custom linear model functions  that use __randomized residuals__ (permutation test) to assess linear model fits on the high-dimensional geomorphic morphometric data [@Collyer:2018,@Collyer:2021]  (rather than assume the data come from a multivariate normal distribution).\n\n|Function | Description|\n|-|----|\n|`procD.lm` | Procrustes ANOVA/regression for Procrustes shape variables|\n|`procD.pgls` | Phylogenetic version of `procD.lm`|\n\n \n`geomorph` has a helper function `geomorph.data.frame` that creates an object of class `geomorph.data.frame` from your procrustes shape coordinates that includes the centroid size (`Csize`), and allows you to associate your metadata such as species and site together with the shape data. The idea is keep it organized in a data-frame like manner, even though it is a list (it makes sure that all the elements have the same length). \n\n\n::: {.cell}\n\n```{.r .cell-code}\ngdf <-geomorph.data.frame(Y.gpa$coords)\nattributes(gdf) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$class\n[1] \"geomorph.data.frame\"\n```\n:::\n\n```{.r .cell-code}\ngdf <-geomorph.data.frame(Y.gpa, \n              species = plethodon$species, \n              site = plethodon$site\n              )\nattributes(gdf) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$names\n[1] \"coords\"  \"Csize\"   \"species\" \"site\"   \n\n$class\n[1] \"geomorph.data.frame\"\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlm.fit <- procD.lm(coords~species * site, data=gdf)\nsummary(lm.fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nAnalysis of Variance, using Residual Randomization\nPermutation procedure: Randomization of null model residuals \nNumber of permutations: 1000 \nEstimation method: Ordinary Least Squares \nSums of Squares and Cross-products: Type I \nEffect sizes (Z) based on F distributions\n\n             Df       SS       MS     Rsq      F      Z Pr(>F)   \nspecies       1 0.029258 0.029258 0.14856 14.544 4.2241  0.001 **\nsite          1 0.064375 0.064375 0.32688 32.000 5.2101  0.001 **\nspecies:site  1 0.030885 0.030885 0.15682 15.352 5.4075  0.001 **\nResiduals    36 0.072422 0.002012 0.36774                        \nTotal        39 0.196940                                         \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCall: procD.lm(f1 = coords ~ species * site, data = gdf)\n```\n:::\n:::\n\n\nThe MANOVA reveals significant shape differences between species, between sites,  and in the interaction between the two factors (species and site).\n\nWe can also look at variation with centroid size:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(procD.lm(coords ~ Csize + species * site, data = gdf))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nAnalysis of Variance, using Residual Randomization\nPermutation procedure: Randomization of null model residuals \nNumber of permutations: 1000 \nEstimation method: Ordinary Least Squares \nSums of Squares and Cross-products: Type I \nEffect sizes (Z) based on F distributions\n\n             Df       SS       MS     Rsq       F      Z Pr(>F)   \nCsize         1 0.010409 0.010409 0.05286  5.2986 2.8820  0.001 **\nspecies       1 0.025661 0.025661 0.13030 13.0625 4.0712  0.001 **\nsite          1 0.063018 0.063018 0.31999 32.0780 5.3722  0.001 **\nspecies:site  1 0.029093 0.029093 0.14773 14.8093 5.2418  0.001 **\nResiduals    35 0.068758 0.001965 0.34913                         \nTotal        39 0.196940                                          \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nCall: procD.lm(f1 = coords ~ Csize + species * site, data = gdf)\n```\n:::\n:::\n\n\nThere is signficant multivariate difference among the shape data by size as well as by species and site. This is a good place to note that while size and shape are _mathematically_ uncorrelated by GPA, there could still be some _biological_ variation that produces some pattern of shape variation with size. \n\n\n#### Relative Warps\n\nWe can look at the relative shape change between the specimens. This is a common technique you will see in the literature using _relative warps analysis_. It uses a shape analysis technique called __thin plate splines__ which is a smoothing method that is forced to go through the landmarks, but will fit a surface between them (in as many diemsions as there are in the data). \n\n__Relative warps analysis__ will show the shape deformation needed to move from a reference shape to a another shape. \n\nFirst we calcuate the mean shape in all of the data as the reference shape. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nref<-mshape(gdf$coords)\n```\n:::\n\n\nCalculate the mean shape of _Plethodon jordanii_, and we can compare this species to the mean of both species: \n\n::: {.cell}\n\n```{.r .cell-code}\ngp1.mn<-mshape(gdf$coords[,,gdf$species==\"Jord\"])\nplotRefToTarget(ref,gp1.mn,mag=2, links=plethodon$links)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n\n```{.r .cell-code}\nplotAllSpecimens(gdf$coords,links=plethodon$links)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-2.png){width=672}\n:::\n:::\n\n\nWe can see that most of the shape change between _P. jordanii_ and the mean shape is around the jaw hinge (points 1,2) and top of the skull (post cranial, points 11,12).  Compare to the sketch of the landmark coordinates. \n\n![Skull landmarks from @Adams:2004](../../images/plethodonlandmarks.png)\n\n\nCan you do the same but comparing the mean of the two species against each other? \n\n# More geomorphic morphometrics software \n\n<https://academic.oup.com/view-large/223239151>\n\n# More reading\n\n- [@Bookstein:1992] Morphometric Tools for Landmark Data: Geometry and Biology\n\n- [@Webster:2010] A Practical Introduction to Landmark-Based Geometric Morphometrics\n\n- [@Bardua:2019] A Practical Guide to Sliding and Surface Semilandmarks in Morphometric Analyses\n\n- [@Savriama:2018] A Step-by-Step Guide for Geometric Morphometrics of Floral Symmetry\n\n- [@Zelditch:2012] Geometric morphometrics for biologists a primer (the green book)\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}